(ns cravendb.indexengine
  (use [cravendb.core]
       [clojure.tools.logging :only (info error)])
  (:import (java.io File File PushbackReader IOException FileNotFoundException ))
  (require [cravendb.lucene :as lucene]
           [cravendb.indexstore :as indexes]
           [cravendb.indexing :as indexing]))

(defn open-storage-for-index [path index]
  (let [storage (lucene/create-index (File. path (index :id)))]
    (-> index
      (assoc :storage storage)
      (assoc :writer (.open-writer storage)))))

(defn compile-index [index]
  (assoc index :map (load-string (index :map))))

(defn load-compiled-indexes [db]
  (with-open [iter (.get-iterator db)]
    (doall (map 
             (comp 
                (partial open-storage-for-index (.path db))
                compile-index 
                read-string) 
              (indexes/iterate-indexes iter)))))

(defn load-from [db]
  (IndexInstance. (load-compiled-indexes db)))

(defn start-background-indexing [db]
  (future 
    (loop []
      (Thread/sleep 100)
      (with-open [indexes (load-from db)]
        (indexing/index-documents! db (get indexes :compiled-indexes))
        (catch Exception e
          (error e)))
      (recur))))

(defprotocol Closeable
  (close [this]))

(defrecord IndexInstance [compiled-indexes]
  Closeable
  (close [this]
    (doseq [i (get this :compiled-indexes)] 
      (do
        (.close (i :storage))
        (.close (i :writer))))))

